{#
  Data Capture Section - Pages 5-6
  
  Data required:
  - data_capture_data: dict with forms, analysis, advanced_targeting, etc.
#}

<section class="section page" data-page="5-6">
    <h1 class="section-title">DATA CAPTURE</h1>
    
    <div class="data-capture-intro">
        {% if data_capture_data.analysis_text %}
            {{ data_capture_data.analysis_text|safe }}
        {% else %}
            <p>
                <em>Data capture analysis unavailable. Review the form performance metrics above to identify optimization opportunities.</em>
            </p>
        {% endif %}
    </div>
    
    <!-- Form Categorization Summary -->
    {% if data_capture_data.categorized_forms %}
    <div class="form-categorization-section">
        <h4 class="subsection-title">Form Performance Summary</h4>
        <div class="categorization-summary">
            <div class="category-stat">
                <span class="stat-value">{{ data_capture_data.categorized_forms.high_performers|length }}</span>
                <span class="stat-label">High Performers (‚â•5% submit rate)</span>
            </div>
            <div class="category-stat">
                <span class="stat-value">{{ data_capture_data.categorized_forms.underperformers|length }}</span>
                <span class="stat-label">Underperformers (<3% with >100 impressions)</span>
            </div>
            <div class="category-stat">
                <span class="stat-value">{{ data_capture_data.categorized_forms.inactive|length }}</span>
                <span class="stat-label">Inactive (0 impressions)</span>
            </div>
        </div>
        
        <!-- Underperforming Forms with Recommendations -->
        {% if data_capture_data.categorized_forms.underperformers %}
        <div class="underperformers-section">
            <h5 class="subsubsection-title">Underperforming Forms Requiring Attention</h5>
            {% for form in data_capture_data.categorized_forms.underperformers %}
            <div class="form-issue-box">
                <div class="form-issue-header">
                    <strong>{{ form.name }}</strong>
                    <span class="form-submit-rate">{{ form.submit_rate|round(2) }}% submit rate</span>
                </div>
                <p class="form-problem">{{ form.problem }}</p>
                {% if form.recommendations %}
                <div class="form-recommendations-detailed">
                    {% for rec in form.recommendations %}
                    {% if rec is mapping %}
                    {# New format: dict with recommendation, effort, expected_impact, priority #}
                    <div class="form-recommendation-item priority-{{ rec.get('priority', 'medium')|lower }}">
                        <div class="rec-header">
                            <strong>{{ rec.get('recommendation', '') }}</strong>
                            <span class="rec-priority priority-{{ rec.get('priority', 'medium')|lower }}">{{ rec.get('priority', 'medium')|upper() }}</span>
                        </div>
                        <div class="rec-details">
                            <span class="rec-effort">‚è±Ô∏è Effort: {{ rec.get('effort', 'N/A') }}</span>
                            <span class="rec-impact">üìà Expected Impact: {{ rec.get('expected_impact', 'N/A') }}</span>
                        </div>
                    </div>
                    {% else %}
                    {# Old format: plain string (backward compatibility) #}
                    <div class="form-recommendation-item">
                        <p>{{ rec }}</p>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Inactive Forms -->
        {% if data_capture_data.categorized_forms.inactive %}
        <div class="inactive-forms-section">
            <h5 class="subsubsection-title">Inactive Forms</h5>
            {% for form in data_capture_data.categorized_forms.inactive %}
            <div class="form-issue-box inactive">
                <div class="form-issue-header">
                    <strong>{{ form.name }}</strong>
                </div>
                <p class="form-problem">{{ form.issue }}</p>
                <p class="form-recommendation"><strong>Recommendation:</strong> {{ form.recommendation }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Form Performance Table -->
    <div class="form-performance-section">
        <h4 class="subsection-title">Data Capture Form Performance in the last 90 Days</h4>
        
        <table class="data-table-green">
            <thead>
                <tr>
                    <th>Name of Form</th>
                    <th>Type</th>
                    <th>Impressions</th>
                    <th>Total Submitted</th>
                    <th>Submit Rate</th>
                    <th>Standing</th>
                </tr>
            </thead>
            <tbody>
                {% for form in data_capture_data.forms %}
                <tr>
                    <td>{{ form.name }}</td>
                    <td>{{ form.type if form.type != "Unknown" else "Embed" }}</td>
                    <td>{{ form.impressions_fmt }}</td>
                    <td>{{ form.submitted_fmt }}</td>
                    <td>{{ form.submit_rate_fmt if form.submit_rate_fmt else (form.submit_rate|round(2)) ~ "%" }}</td>
                    <td>
                        <span class="standing standing-{{ form.standing|lower }}">{{ form.standing }}</span>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="no-data">No form data available</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if data_capture_data.areas_of_opportunity %}
    <div class="areas-of-opportunity-section">
        <h4 class="subsection-title">Areas of Opportunity</h4>
        <table class="opportunity-table">
            <thead>
                <tr>
                    <th>Opportunity</th>
                    <th>Recommended Action</th>
                    <th>Why it Matters</th>
                </tr>
            </thead>
            <tbody>
                {% for opp in data_capture_data.areas_of_opportunity %}
                <tr>
                    <td>{{ opp.opportunity }}</td>
                    <td>{{ opp.recommended_action }}</td>
                    <td>{{ opp.why_it_matters }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    {# Strategic Value Elements #}
    {% from "components/strategic_value_elements.html" import root_cause_analysis, risk_flags, quick_wins, enhanced_recommendations %}
    
    {% if data_capture_data.root_cause_analysis %}
    {{ root_cause_analysis(data_capture_data.root_cause_analysis) }}
    {% endif %}
    
    {% if data_capture_data.risk_flags %}
    {{ risk_flags(data_capture_data.risk_flags) }}
    {% endif %}
    
    {% if data_capture_data.quick_wins %}
    {{ quick_wins(data_capture_data.quick_wins) }}
    {% endif %}
    
    {% if data_capture_data.recommendations %}
    {{ enhanced_recommendations(data_capture_data.recommendations) }}
    {% endif %}
    
    <!-- Advanced Targeting Section -->
    {% if data_capture_data.advanced_targeting or data_capture_data.progressive_profiling or data_capture_data.flyout_forms %}
    <div class="advanced-section">
        {% if data_capture_data.advanced_targeting %}
        <div class="tactics-section">
            <h4>Advanced Targeting</h4>
            <ul class="tactics-list">
                {% for tactic in data_capture_data.advanced_targeting %}
                <li>{{ tactic }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        
        {% if data_capture_data.progressive_profiling %}
        <div class="tactics-section">
            <h4>Progressive Profiling</h4>
            {% if data_capture_data.progressive_profiling is mapping %}
            {# New format: dict with enabled, recommendation, etc. #}
            <div class="profiling-status">
                <strong>Status:</strong> 
                <span class="status-badge {% if data_capture_data.progressive_profiling.enabled %}enabled{% else %}not-enabled{% endif %}">
                    {% if data_capture_data.progressive_profiling.enabled %}Enabled{% else %}Not Enabled{% endif %}
                </span>
            </div>
            {% if data_capture_data.progressive_profiling.get('evidence') %}
            <p class="profiling-evidence"><em>{{ data_capture_data.progressive_profiling.evidence }}</em></p>
            {% endif %}
            {% if data_capture_data.progressive_profiling.get('recommendation') %}
            <p class="profiling-recommendation">{{ data_capture_data.progressive_profiling.recommendation }}</p>
            {% endif %}
            {% else %}
            {# Old format: list (backward compatibility) #}
            <ul class="tactics-list">
                {% for item in data_capture_data.progressive_profiling %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
        {% endif %}
        
        {% if data_capture_data.flyout_forms %}
        <div class="tactics-section">
            <h4>Flyout Forms</h4>
            {% if data_capture_data.flyout_forms is mapping %}
            {# New format: dict with enabled, count, recommendation, etc. #}
            <div class="flyout-status">
                <strong>Status:</strong> 
                <span class="status-badge {% if data_capture_data.flyout_forms.enabled %}enabled{% else %}not-enabled{% endif %}">
                    {% if data_capture_data.flyout_forms.enabled %}Enabled{% else %}Not Enabled{% endif %}
                </span>
                {% if data_capture_data.flyout_forms.get('count') %}
                <span class="flyout-count">({{ data_capture_data.flyout_forms.count }} form{{ 's' if data_capture_data.flyout_forms.count != 1 else '' }})</span>
                {% endif %}
            </div>
            {% if data_capture_data.flyout_forms.get('avg_submit_rate') is not none %}
            <p class="flyout-performance">Average submit rate: {{ data_capture_data.flyout_forms.avg_submit_rate }}%</p>
            {% endif %}
            {% if data_capture_data.flyout_forms.get('recommendation') %}
            <p class="flyout-recommendation">{{ data_capture_data.flyout_forms.recommendation }}</p>
            {% endif %}
            {% else %}
            {# Old format: list (backward compatibility) #}
            <ul class="tactics-list">
                {% for item in data_capture_data.flyout_forms %}
                <li>{{ item }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endif %}
</section>

<style>
.data-capture-intro p {
    font-family: 'Montserrat', sans-serif;
    font-size: 1.17rem; /* Match sample: 1.166667em for body text */
    line-height: 1.6; /* Match sample line height */
    color: #000000; /* Match sample: pure black */
    margin-bottom: 2rem;
}

.form-performance-section {
    margin: 2rem 0;
}

.subsection-title {
    font-family: 'Montserrat', sans-serif;
    font-size: 1.17rem; /* Reduced from 2.17rem - was too large */
    font-weight: 700;
    color: #000000; /* Match sample: pure black */
    margin-bottom: 1rem;
    margin-top: 1.5rem;
    line-height: 1.3;
}

/* Standing badges */
.standing {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    border-radius: 0;
}

.standing-excellent {
    background: #D1FAE5;
    color: #065F46;
}

.standing-good {
    background: #65DA4F;
    color: #262626;
}

.standing-average {
    background: #FEF3C7;
    color: #92400E;
}

.standing-poor {
    background: #FEE2E2;
    color: #991B1B;
}

.form-analysis {
    margin: 2rem 0;
}

.form-analysis p {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
    line-height: 1.8;
    margin-bottom: 1rem;
}

.recommendations-list {
    margin: 1rem 0 1rem 1.5rem;
}

.recommendations-list li {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
    line-height: 1.8;
    margin-bottom: 1rem;
}

.recommendations-list ul {
    margin-top: 0.5rem;
    margin-left: 1.5rem;
}

.advanced-section {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #E5E7EB;
}

.advanced-section p {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
    line-height: 1.8;
    margin-bottom: 1rem;
}

.tactics-section {
    margin: 1.5rem 0;
}

.tactics-section h4 {
    font-family: 'Montserrat', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: #262626;
}

.tactics-list {
    margin: 0 0 0 1.5rem;
    padding: 0;
}

.tactics-list li {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
    line-height: 1.6;
    margin-bottom: 0.5rem;
}

/* Form Categorization Styles */
.form-categorization-section {
    margin: 2rem 0;
}

.categorization-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
}

.category-stat {
    background: #F9F9F9;
    border: 1px solid #E5E7EB;
    padding: 1rem;
    text-align: center;
}

.stat-value {
    display: block;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    color: #000000;
    margin-bottom: 0.5rem;
}

.stat-label {
    display: block;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.85rem;
    color: #666;
}

.underperformers-section,
.inactive-forms-section {
    margin-top: 2rem;
}

.subsubsection-title {
    font-family: 'Montserrat', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    color: #000000;
    margin-bottom: 1rem;
}

.form-issue-box {
    background: #FFFFFF;
    border-left: 4px solid #F59E0B;
    padding: 1rem 1.5rem;
    margin-bottom: 1rem;
}

.form-issue-box.inactive {
    border-left-color: #9CA3AF;
}

.form-issue-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    font-family: 'Montserrat', sans-serif;
    font-size: 1rem;
    font-weight: 600;
    color: #000000;
}

.form-submit-rate {
    font-size: 0.9rem;
    color: #666;
    font-weight: 400;
}

.form-problem {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
    line-height: 1.6;
    color: #262626;
    margin-bottom: 0.75rem;
}

.form-recommendation {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.9rem;
    line-height: 1.6;
    color: #666;
    margin: 0;
}

.form-recommendations {
    margin: 0.75rem 0 0 1.5rem;
    padding: 0;
}

.form-recommendations li {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.9rem;
    line-height: 1.6;
    color: #262626;
    margin-bottom: 0.5rem;
}

/* Enhanced form recommendations with effort/impact */
.form-recommendations-detailed {
    margin: 1rem 0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.form-recommendation-item {
    background: #F9FAFB;
    border-left: 4px solid #65DA4F;
    padding: 1rem;
    border-radius: 4px;
    font-family: 'Montserrat', sans-serif;
}

.form-recommendation-item.priority-high {
    border-left-color: #EF4444;
    background: #FEF2F2;
}

.form-recommendation-item.priority-medium {
    border-left-color: #F59E0B;
    background: #FFFBEB;
}

.form-recommendation-item.priority-low {
    border-left-color: #6B7280;
    background: #F9FAFB;
}

.rec-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
    gap: 1rem;
}

.rec-header strong {
    font-size: 0.95rem;
    line-height: 1.5;
    color: #111827;
    flex: 1;
}

.rec-priority {
    font-size: 0.75rem;
    font-weight: 700;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    white-space: nowrap;
}

.rec-priority.priority-high {
    background: #FEE2E2;
    color: #991B1B;
}

.rec-priority.priority-medium {
    background: #FEF3C7;
    color: #92400E;
}

.rec-priority.priority-low {
    background: #E5E7EB;
    color: #374151;
}

.rec-details {
    display: flex;
    gap: 1.5rem;
    font-size: 0.85rem;
    color: #6B7280;
    margin-top: 0.5rem;
}

.rec-effort, .rec-impact {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

/* Status badges for progressive profiling and flyout forms */
.status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.status-badge.enabled {
    background: #D1FAE5;
    color: #065F46;
}

.status-badge.not-enabled {
    background: #FEE2E2;
    color: #991B1B;
}

.profiling-status,
.flyout-status {
    margin-bottom: 0.75rem;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
}

.profiling-evidence,
.profiling-recommendation,
.flyout-performance,
.flyout-recommendation {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.9rem;
    line-height: 1.6;
    color: #374151;
    margin: 0.5rem 0;
}

.profiling-evidence {
    font-style: italic;
    color: #6B7280;
}

.flyout-count {
    color: #6B7280;
    font-size: 0.85rem;
    margin-left: 0.5rem;
}

@media print {
    .data-capture-intro,
    .form-analysis,
    .advanced-section,
    .form-categorization-section {
        page-break-inside: avoid;
    }
}
</style>

{# Include strategic value elements styles #}
{% include "components/strategic_value_elements_styles.html" %}

