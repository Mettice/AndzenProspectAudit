<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Customer Journey Marketing: Audit Insights{% endblock %}</title>
    <link rel="stylesheet" href="assets/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        {% block inline_styles %}{% endblock %}
    </style>
</head>
<body>
    <div class="audit-report">
        {% block content %}{% endblock %}
    </div>
    
    <script>
        {% block scripts %}
        // Chart initialization function
        function initCharts() {
            document.querySelectorAll('canvas[data-chart-type]').forEach(function(canvas) {
                const chartType = canvas.getAttribute('data-chart-type');
                const configStr = canvas.getAttribute('data-chart-config');
                
                try {
                    const config = JSON.parse(configStr || '{}');
                    
                    // Handle different data formats
                    let datasets = [];
                    
                    if (config.datasets) {
                        // Pre-formatted datasets
                        datasets = config.datasets;
                    } else if (config.total_revenue || config.flow_revenue || config.attributed_revenue) {
                        // Revenue chart format - Match sample audit structure
                        // Sample shows: Bars for attributed/unattributed revenue, Line for recipients
                        if (config.attributed_revenue) {
                            datasets.push({
                                label: 'Attributed Revenue',
                                data: config.attributed_revenue,
                                backgroundColor: 'rgba(59, 130, 246, 0.6)',  // Blue bars (matches sample)
                                borderColor: 'rgba(59, 130, 246, 1)',
                                type: 'bar',
                                order: 1
                            });
                        }
                        if (config.unattributed_revenue) {
                            datasets.push({
                                label: 'Unattributed Revenue',
                                data: config.unattributed_revenue,
                                backgroundColor: 'rgba(101, 218, 79, 0.6)',  // Green bars (matches sample)
                                borderColor: 'rgba(101, 218, 79, 1)',
                                type: 'bar',
                                order: 1
                            });
                        }
                        if (config.total_recipients && config.total_recipients.length > 0) {
                            datasets.push({
                                label: 'Total Recipients',
                                data: config.total_recipients,
                                backgroundColor: 'rgba(252, 211, 77, 0.6)',  // Yellow line (matches sample)
                                borderColor: 'rgba(252, 211, 77, 1)',
                                type: 'line',
                                yAxisID: 'y1',  // Use secondary Y-axis for recipients
                                order: 0,
                                tension: 0.1
                            });
                        }
                        // Keep flow/campaign revenue as optional lines (for detailed view)
                        if (config.flow_revenue && !config.unattributed_revenue) {
                            datasets.push({
                                label: 'Flow Revenue',
                                data: config.flow_revenue,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                type: 'line',
                                order: 2
                            });
                        }
                        if (config.campaign_revenue && !config.unattributed_revenue) {
                            datasets.push({
                                label: 'Campaign Revenue',
                                data: config.campaign_revenue,
                                backgroundColor: 'rgba(255, 206, 86, 0.6)',
                                borderColor: 'rgba(255, 206, 86, 1)',
                                type: 'line',
                                order: 2
                            });
                        }
                        if (config.total_revenue && !config.attributed_revenue && !config.unattributed_revenue) {
                            datasets.push({
                                label: 'Total Revenue',
                                data: config.total_revenue,
                                backgroundColor: 'rgba(101, 218, 79, 0.6)',
                                borderColor: 'rgba(101, 218, 79, 1)',
                                type: chartType === 'bar_line' ? 'bar' : chartType,
                                order: 1
                            });
                        }
                    } else if (config.new_subscribers || config.net_change || (config.values && (config.months || config.labels))) {
                        // List growth format - handle both months/net_change and values/labels formats
                        if (config.new_subscribers && config.new_subscribers.length > 0) {
                            datasets.push({
                                label: 'New Subscribers',
                                data: config.new_subscribers,
                                backgroundColor: 'rgba(101, 218, 79, 0.6)',
                                borderColor: 'rgba(101, 218, 79, 1)',
                                type: 'bar'
                            });
                        }
                        if (config.net_change && config.net_change.length > 0) {
                            datasets.push({
                                label: 'Net Change',
                                data: config.net_change,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                type: 'line'
                            });
                        }
                        // Fallback: if we have values but no new_subscribers/net_change, use values
                        if (datasets.length === 0 && config.values && config.values.length > 0) {
                            datasets.push({
                                label: 'Net Change',
                                data: config.values,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                type: 'bar'
                            });
                        }
                    } else if (config.values) {
                        // Generic values format
                        datasets.push({
                            label: 'Data',
                            data: config.values,
                            backgroundColor: 'rgba(101, 218, 79, 0.6)',
                            borderColor: 'rgba(101, 218, 79, 1)',
                            borderWidth: 1
                        });
                    }
                    
                    // Skip empty charts
                    if (datasets.length === 0) {
                        console.warn('No chart data found for', canvas.id);
                        return;
                    }
                    
                    // Create Chart.js chart
                    new Chart(canvas.getContext('2d'), {
                        type: chartType === 'bar_line' ? 'bar' : chartType,
                        data: {
                            labels: config.labels || config.months || [],
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false, // Hide default legend, use custom legend below chart
                                    position: 'top',
                                    labels: {
                                        font: {
                                            family: "'Montserrat', sans-serif",
                                            size: 12,
                                            weight: 600
                                        },
                                        color: '#000000',
                                        padding: 15,
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleFont: {
                                        family: "'Montserrat', sans-serif",
                                        size: 14,
                                        weight: 700
                                    },
                                    bodyFont: {
                                        family: "'Montserrat', sans-serif",
                                        size: 12
                                    },
                                    padding: 12,
                                    cornerRadius: 4,
                                    displayColors: true
                                }
                            },
                            scales: chartType !== 'pie' ? {
                                y: {
                                    beginAtZero: true,
                                    position: 'left',
                                    ticks: {
                                        font: {
                                            family: "'Montserrat', sans-serif",
                                            size: 11
                                        },
                                        color: '#000000',
                                        callback: function(value) {
                                            return '$' + value.toLocaleString();
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.1)',
                                        drawBorder: true,
                                        borderColor: '#E5E7EB'
                                    }
                                },
                                y1: config.total_recipients && config.total_recipients.length > 0 ? {
                                    beginAtZero: true,
                                    position: 'right',
                                    grid: {
                                        drawOnChartArea: false
                                    },
                                    ticks: {
                                        font: {
                                            family: "'Montserrat', sans-serif",
                                            size: 11
                                        },
                                        color: '#000000',
                                        callback: function(value) {
                                            return value.toLocaleString();
                                        }
                                    }
                                } : undefined,
                                x: {
                                    ticks: {
                                        font: {
                                            family: "'Montserrat', sans-serif",
                                            size: 11
                                        },
                                        color: '#000000'
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.1)',
                                        drawBorder: true,
                                        borderColor: '#E5E7EB'
                                    }
                                }
                            } : {}
                        }
                    });
                } catch (e) {
                    console.error('Chart initialization failed for', canvas.id, ':', e);
                }
            });
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Set progress bar widths from data attributes
            document.querySelectorAll('.progress-fill[data-width]').forEach(function(el) {
                el.style.width = el.getAttribute('data-width') + '%';
            });
            
            // Initialize charts
            if (typeof Chart !== 'undefined') {
                initCharts();
            }
        });
        {% endblock %}
    </script>
</body>
</html>

